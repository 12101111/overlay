From fbbe8afc3e8594be315f7513bf7fcebb2135ae78 Mon Sep 17 00:00:00 2001
From: "trop[bot]" <37223003+trop[bot]@users.noreply.github.com>
Date: Wed, 4 Mar 2020 16:19:16 +0900
Subject: [PATCH 2/5] fix: bail early if no printers on the network (#22517)

Co-authored-by: Shelley Vohr <shelley.vohr@gmail.com>
---
 docs/api/web-contents.md                   | 2 +-
 shell/browser/api/atom_api_web_contents.cc | 8 ++++++++
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/docs/api/web-contents.md b/docs/api/web-contents.md
index 05e789bb4..f51bb9821 100644
--- a/docs/api/web-contents.md
+++ b/docs/api/web-contents.md
@@ -1264,7 +1264,7 @@ Returns [`PrinterInfo[]`](structures/printer-info.md)
     * `vertical` Number (optional) - The vertical dpi.
 * `callback` Function (optional)
   * `success` Boolean - Indicates success of the print call.
-  * `failureReason` String - Called back if the print fails; can be `cancelled` or `failed`.
+  * `failureReason` String - Error description called back if the print fails.
 
 Prints window's web page. When `silent` is set to `true`, Electron will pick
 the system's default printer if `deviceName` is empty and the default settings for printing.
diff --git a/shell/browser/api/atom_api_web_contents.cc b/shell/browser/api/atom_api_web_contents.cc
index 5d5704122..6431391b1 100644
--- a/shell/browser/api/atom_api_web_contents.cc
+++ b/shell/browser/api/atom_api_web_contents.cc
@@ -1679,6 +1679,14 @@ void WebContents::OnGetDefaultPrinter(
     base::string16 default_printer) {
   base::string16 printer_name =
       device_name.empty() ? default_printer : device_name;
+
+  // If there are no valid printers available on the network, we bail.
+  if (printer_name.empty() || !IsDeviceNameValid(printer_name)) {
+    if (print_callback)
+      std::move(print_callback).Run(false, "no valid printers available");
+    return;
+  }
+
   print_settings.SetStringKey(printing::kSettingDeviceName, printer_name);
 
   auto* print_view_manager =
-- 
2.25.1

